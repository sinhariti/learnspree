const mongoose = require('mongoose');
const Student = require('../models/Student');
const Performance = require('../models/Performance');
const DailyPlan = require('../models/DailyPlan');
const { reflectAndReschedule } = require('../agents/reflectionAgent');
require('dotenv').config();

async function testReflection() {
  console.log('--- Reflection Agent Test ---');

  try {
    await mongoose.connect(process.env.MONGODB_URI);
    console.log('✅ Connected to MongoDB');

    const studentId = "demo_student";

    // 1. Clear existing test data
    console.log('Cleaning up existing test data...');
    await Student.deleteMany({ studentId });
    await Performance.deleteMany({ studentId });
    await DailyPlan.deleteMany({ studentId });

    // 2. Seed Student (Current Day 4)
    console.log('Seeding student data...');
    await Student.create({
      studentId,
      examName: "GATE CS 2025",
      totalDays: 30,
      hoursPerDay: 3,
      syllabus: ["Operating Systems", "DBMS", "Computer Networks", "Algorithms"],
      currentDay: 4
    });

    // 3. Seed Performance (Last 3 days: OS strong, DBMS weak)
    console.log('Seeding past performance (Day 1: OS 85%, Day 2: DBMS 45%, Day 3: DBMS 40%)...');
    await Performance.insertMany([
      { studentId, day: 1, topic: "Operating Systems", quizScore: 85, timeSpent: 180, difficulty: "medium" },
      { studentId, day: 2, topic: "DBMS", quizScore: 45, timeSpent: 180, mistakes: ["Normalization"], difficulty: "medium" },
      { studentId, day: 3, topic: "DBMS", quizScore: 40, timeSpent: 180, mistakes: ["SQL Joins"], difficulty: "medium" }
    ]);

    // 4. Seed Upcoming Plans (Days 4-10 generic)
    console.log('Seeding generic future plans (Days 4-10)...');
    const plans = [];
    for (let i = 4; i <= 10; i++) {
      plans.push({
        studentId,
        day: i,
        date: new Date(Date.now() + (i - 4) * 24 * 60 * 60 * 1000), // starting from today
        topics: i % 2 === 0 ? ["Computer Networks"] : ["Algorithms"],
        tasks: [
          {
            topic: i % 2 === 0 ? "Computer Networks" : "Algorithms",
            type: "theory",
            duration: 180,
            description: "Default study session"
          }
        ],
        aiReasoning: "Baseline plan generated by planner."
      });
    }
    await DailyPlan.insertMany(plans);

    // 5. Run Reflection
    console.log('\n[Reflection Logic] Running adaptive rescheduling...');
    const reflectionResults = await reflectAndReschedule(studentId);

    if (!reflectionResults) {
      console.log('No reflection results generated.');
      return;
    }

    console.log('\n--- Reflection Analysis ---');
    console.log('Weak Topics identified:', reflectionResults.analysis.weakTopics.join(', '));
    console.log('Strong Topics identified:', reflectionResults.analysis.strongTopics.join(', '));
    console.log('Reasoning:', reflectionResults.analysis.reasoning);

    console.log('\n--- Adjustments Log ---');
    reflectionResults.adjustments.forEach(adj => {
      console.log(`Day ${adj.day}: ${adj.changes.length} changes applied.`);
      adj.changes.forEach(c => {
        console.log(`  - ${c.action.toUpperCase()}: ${c.reason}`);
      });
    });

    // 6. Verify Database State
    console.log('\n--- Verifying Database Changes ---');
    const updatedPlans = await DailyPlan.find({ studentId, day: { $gte: 4, $lte: 10 } }).sort({ day: 1 });

    let dbmsFound = false;
    let osReduced = false;

    updatedPlans.forEach(p => {
      const hasDBMS = p.tasks.some(t => t.topic.toLowerCase().includes("dbms"));
      const osTask = p.tasks.find(t => t.topic.toLowerCase().includes("operating systems"));

      if (hasDBMS) dbmsFound = true;
      if (osTask && (osTask.type === 'revision' || osTask.duration < 60)) osReduced = true;

      console.log(`Day ${p.day}: [${p.tasks.map(t => t.topic).join(', ')}]`);
    });

    console.log('\nVerification Summary:');
    if (dbmsFound) {
      console.log('✅ Success: DBMS (weak topic) injected into future schedule.');
    } else {
      console.log('❌ Failure: DBMS not found in future schedule.');
    }

    const updatedStudent = await Student.findOne({ studentId });
    if (updatedStudent.weakTopics.includes("DBMS")) {
      console.log('✅ Success: Student profile updated with weak topics.');
    }

  } catch (error) {
    console.error('\n❌ Reflection test failed:', error);
  } finally {
    await mongoose.connection.close();
    process.exit(0);
  }
}

testReflection();
